<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenArtML Voice Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pulse {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        .chat-bubble-user {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .chat-bubble-ai {
            background-color: #4B5563; /* gray-600 */
            color: white;
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #1F2937; /* gray-800 */
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #4B5563; /* gray-600 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl h-[85vh] bg-gray-800 rounded-2xl shadow-2xl flex flex-col p-6">

        <!-- Header -->
        <div class="flex-shrink-0 flex justify-between items-center pb-4 border-b border-gray-700 flex-wrap gap-4">
            <h1 class="text-2xl font-bold text-gray-100">GenArtML Voice Assistant</h1>
            <div class="flex items-center space-x-4 flex-wrap gap-4">
                 <div class="flex items-center space-x-2">
                    <label for="api-key-input" class="text-sm font-medium text-gray-400 whitespace-nowrap">API Key:</label>
                    <input type="password" id="api-key-input" placeholder="Enter your Gemini API key" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5" value="AIzaSyC96caA_14oe4E6NgXhIsM4gsKfY5HuM9U">
                </div>
                <div class="flex items-center space-x-2">
                    <label for="voice-select" class="text-sm font-medium text-gray-400">Voice:</label>
                    <select id="voice-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5">
                        <!-- Voices will be populated by JS -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-grow my-4 overflow-y-auto pr-2">
            <!-- Chat messages will appear here -->
             <div class="flex justify-start mb-4">
                <div class="chat-bubble-ai rounded-lg py-2 px-4 max-w-md">
                    <p class="text-sm">Hello! How can I help you today?</p>
                </div>
            </div>
        </div>

        <!-- Status & Control -->
        <div class="flex-shrink-0 text-center">
            <p id="status" class="text-gray-400 h-6 mb-4 transition-opacity duration-300">Tap the mic to start</p>
            <button id="mic-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-5 transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 mx-auto flex items-center justify-center w-20 h-20 shadow-lg">
                <!-- Icon will be inserted by JS -->
            </button>
             <p id="error-log" class="text-red-400 text-sm mt-4 h-5"></p>
        </div>
    </div>

    <script>
        const micBtn = document.getElementById('mic-btn');
        const statusEl = document.getElementById('status');
        const chatContainer = document.getElementById('chat-container');
        const errorLog = document.getElementById('error-log');
        const voiceSelect = document.getElementById('voice-select');
        const apiKeyInput = document.getElementById('api-key-input');
        
        // The API key is now read from the input field.
        // const apiKey = ''; 

        const ICONS = {
            mic: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 10.15V16a1 1 0 11-2 0v-1.85A5.002 5.002 0 015 9V4a5 5 0 0110 0v5a5.002 5.002 0 01-3 4.15z" clip-rule="evenodd" /></svg>`,
            stop: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><rect width="10" height="10" x="5" y="5" rx="1" /></svg>`,
            loading: `<svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`,
        };

        const VOICES = [
            { name: "Sulafat (Warm, Female)", id: "Sulafat" },
            { name: "Vindemiatrix (Gentle, Female)", id: "Vindemiatrix" },
            { name: "Kore (Firm, Female)", id: "Kore" },
            { name: "Leda (Youthful, Female)", id: "Leda" },
            { name: "Callirrhoe (Easy-going, Female)", id: "Callirrhoe" },
            { name: "Puck (Upbeat, Male)", id: "Puck" },
            { name: "Charon (Informative, Male)", id: "Charon" },
            { name: "Fenrir (Excitable, Male)", id: "Fenrir" },
            
        ];
        
        let isListening = false;
        let isSpeaking = false;
        let recognition;
        let audioContext;
        let audioQueue = [];
        
        // --- BROWSER COMPATIBILITY CHECK ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            setStatus("Speech recognition not supported in this browser.", true);
            micBtn.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                setStatus('Listening...');
                micBtn.innerHTML = ICONS.stop;
                micBtn.classList.add('pulse');
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.innerHTML = ICONS.mic;
                micBtn.classList.remove('pulse');
                if (statusEl.textContent === 'Listening...') {
                    setStatus('Tap the mic to start');
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                logError(`Error: ${event.error}. Please try again.`);
                setStatus('Tap the mic to start');
            };

            recognition.onresult = (event) => {
                let interim_transcript = '';
                let final_transcript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }

                // Provide real-time feedback to the user
                if (interim_transcript) {
                   setStatus(`"${interim_transcript}"`);
                }

                // Process the final transcript
                if (final_transcript) {
                    const finalTranscriptClean = final_transcript.trim();
                    if (finalTranscriptClean) {
                        addChatMessage(finalTranscriptClean, 'user');
                        handleUserInput(finalTranscriptClean);
                    }
                }
            };
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            micBtn.innerHTML = ICONS.mic;
            populateVoices();
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser.", e);
                logError("Audio playback is not supported here.");
            }
        };

        function populateVoices() {
            VOICES.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = voice.name;
                voiceSelect.appendChild(option);
            });
            voiceSelect.value = "Sulafat"; // Default polite voice
        }

        // --- UI & STATE MANAGEMENT ---
        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.classList.toggle('text-red-400', isError);
            statusEl.classList.toggle('text-gray-400', !isError);
        }

        function logError(message) {
            errorLog.textContent = message;
            setTimeout(() => { errorLog.textContent = ''; }, 5000);
        }
        
        function addChatMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `rounded-lg py-2 px-4 max-w-md ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            
            const p = document.createElement('p');
            p.className = 'text-sm';
            p.textContent = text;

            bubble.appendChild(p);
            messageWrapper.appendChild(bubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- CORE LOGIC ---
        micBtn.addEventListener('click', () => {
            if (!apiKeyInput.value.trim()) {
                logError("Please enter your Gemini API key to start.");
                return;
            }
            if (isListening) {
                recognition.stop();
            } else if (!isSpeaking) {
                recognition.start();
            }
        });

        async function handleUserInput(text) {
            setStatus('Thinking...');
            micBtn.innerHTML = ICONS.loading;
            micBtn.disabled = true;

            try {
                const aiResponse = await callGeminiChat(text);
                addChatMessage(aiResponse, 'ai');
                await speakText(aiResponse);
            } catch (error) {
                console.error("Error processing user input:", error);
                const errorMessage = "Sorry, I couldn't process that. Please try again.";
                addChatMessage(errorMessage, 'ai');
                logError(error.message || "An unknown error occurred.");
            } finally {
                setStatus('Tap the mic to start');
                micBtn.innerHTML = ICONS.mic;
                micBtn.disabled = false;
            }
        }
        
        async function callGeminiChat(prompt) {
             const apiKey = apiKeyInput.value.trim();
             if (!apiKey) throw new Error("API Key is missing.");

             const systemPrompt = "You are a polite, charming, and helpful AI voice assistant. Keep your answers concise and clear, suitable for being spoken aloud. Always be friendly and courteous.";
             const model = 'gemini-2.5-flash-preview-05-20';
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

             const payload = {
                 contents: [{ parts: [{ text: prompt }] }],
                 systemInstruction: { parts: [{ text: systemPrompt }] },
             };

             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });

             if (!response.ok) {
                 const errorBody = await response.text();
                 throw new Error(`GenArtML API Error: ${response.status} ${errorBody}`);
             }

             const result = await response.json();
             return result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure how to respond to that.";
        }

        async function speakText(text) {
            setStatus('Speaking...');
            isSpeaking = true;
            micBtn.disabled = true;

            try {
                await generateAndPlayAudio(text);
            } catch (error) {
                console.error("Error in speakText:", error);
                logError("Sorry, there was an issue with the voice.");
            } finally {
                isSpeaking = false;
                micBtn.disabled = false;
                setStatus('Tap the mic to start');
            }
        }

        async function generateAndPlayAudio(text) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) throw new Error("API Key is missing.");

            const selectedVoice = voiceSelect.value;
            const model = 'gemini-2.5-flash-preview-tts';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: `Say in a polite and charming tone: ${text}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: selectedVoice }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`GenArtML TTS API error: ${response.status} ${errorBody}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                if (!sampleRateMatch) throw new Error("Could not determine sample rate from mimetype.");
                
                const sampleRate = parseInt(sampleRateMatch[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, 1, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                return new Promise((resolve) => {
                    const audio = new Audio(audioUrl);
                    audio.onended = resolve;
                    audio.play();
                });
            } else {
                throw new Error("Invalid audio data received from API.");
            }
        }
        
        // --- AUDIO UTILITIES ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, numChannels, sampleRate) {
            const a = pcmData.length * 2;
            const b = sampleRate * numChannels * 2;
            const c = numChannels * 2;
            
            const buffer = new ArrayBuffer(44 + a);
            const view = new DataView(buffer);

            /* RIFF identifier */
            writeString(view, 0, 'RIFF');
            /* file length */
            view.setUint32(4, 36 + a, true);
            /* RIFF type */
            writeString(view, 8, 'WAVE');
            /* format chunk identifier */
            writeString(view, 12, 'fmt ');
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (raw) */
            view.setUint16(20, 1, true);
            /* channel count */
            view.setUint16(22, numChannels, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sample rate * block align) */
            view.setUint32(28, b, true);
            /* block align (channel count * bytes per sample) */
            view.setUint16(32, c, true);
            /* bits per sample */
            view.setUint16(34, 16, true);
            /* data chunk identifier */
            writeString(view, 36, 'data');
            /* data chunk length */
            view.setUint32(40, a, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

    </script>
</body>
</html>









